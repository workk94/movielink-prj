<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- jQuery 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <title>Title</title>
    <link rel="stylesheet" href="/css/postOneDetailCss.css">
    <style>
        body {
            font-family: 'AppleSDGothicNeoM', sans-serif;
        }

        #tag-container {
            display: flex;
            flex-wrap: wrap;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e0e0;
            border-radius: 15px;
            padding: 5px 10px;
            margin: 3px;
            font-size: 14px;
        }

        .liked {
            background-color: red;
            color: white;
        }

        .unliked {
            background-color: gray;
            color: black;
        }

        .comment-item,
        .reply-item {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            padding: 10px;
            background-color: skyblue;
        }

        .replies {
            margin-left: 30px;
            border-left: 2px solid #ccc;
            padding-left: 10px;
        }

        .comment-item p {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        textarea {
            width: 100%;
            height: 60px;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
    <script th:inline="javascript">

        // 전역 변수 설정
        let csrfToken = '';
        let csrfHeader = '';
        let postId = 0;
        let memId = 0;
        let isAuthenticated = false;

        document.addEventListener('DOMContentLoaded', async () => {

            console.log('CSRF 설정:', getCsrfHeaders()); // 디버깅용 출력

            const likeButton = document.getElementById('likeButton');
            const submitCommentBtn = document.getElementById('submitCommentBtn');
            const commentList = document.getElementById('comments-list');

            if (likeButton) {
                postId = likeButton.getAttribute('data-post-id');
                console.log('postId:', postId); // 디버깅용 출력
                likeButton.addEventListener('click', async () => {
                    if (await checkAuthOnDemand()) {
                        handleLike(postId); // 로그인 성공 시 좋아요 처리
                    }
                });
            }
            if (submitCommentBtn) {
                submitCommentBtn.addEventListener('click', async () => {
                    if (await checkAuthOnDemand()) {
                        addComment(postId); // 로그인 성공 시만 댓글 추가
                    }
                });
                if (commentList && !commentList.dataset.listenerAttached) { // 중복 방지 플래그
                    commentList.dataset.listenerAttached = true;
                    commentList.addEventListener('click', async (event) => {
                        const target = event.target;
                        const commentId = target.getAttribute('data-id');

                        if (target.classList.contains('edit-btn')) {
                            if (await checkAuthOnDemand()) {
                                editComment(commentId); // 수정
                            }
                        } else if (target.classList.contains('delete-btn')) {
                            if (await checkAuthOnDemand()) {
                                deleteComment(commentId); // 삭제
                            }
                        } else if (target.classList.contains('reply-btn')) {
                            if (await checkAuthOnDemand()) {
                                addReply(commentId); // 대댓글
                            }
                        }
                    });

                }
            });
        async function checkAuthOnDemand() {
            try {
                const response = await fetch('/community/auth/check', {
                    method: 'GET',
                    headers: getCsrfHeaders(),
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('서버 오류 발생');

                const data = await response.json();
                console.log('인증 데이터:', data); // 디버깅 추가

                isAuthenticated = data.authenticated;
                memId = data.memId || 0;
                console.log('memId:', memId); // 디버깅용

                // 버튼 클릭 시에만 로그인 필요 알림
                if (!isAuthenticated) {
                    alert('로그인이 필요합니다.');
                    return false;
                }
                return true;
            } catch (err) {
                console.error('인증 체크 오류:', err);
                alert('서버 오류로 인증 상태를 확인할 수 없습니다.');
                return false;
            }
        }

        function getCsrfHeaders() {
            const csrfTokenMeta = document.querySelector("meta[name='_csrf']");
            const csrfHeaderMeta = document.querySelector("meta[name='_csrf_header']");

            if (!csrfTokenMeta || !csrfHeaderMeta) {
                console.error("CSRF 토큰이 누락되었습니다.");
                alert("보안 설정 오류가 발생했습니다.");
                return {};
            }

            return {
                "Content-Type": "application/json",
                [csrfHeaderMeta.content]: csrfTokenMeta.content
            };
        }

        // 인증 상태 체크 함수
        async function checkAuth() {
            try {
                const response = await fetch('/community/auth/check', {
                    method: 'GET',
                    headers: getCsrfHeaders(),
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('서버 오류 발생');

                const data = await response.json();
                console.log('인증 데이터:', data); // 디버깅 추가

                isAuthenticated = data.authenticated;
                memId = data.memId || 0;
                console.log('memId:', memId); // 디버깅용

                // 로그인 상태가 아니면 경고창만 표시 (페이지 이동 없음)
                if (!isAuthenticated) {
                    alert('로그인이 필요합니다.');
                }
            } catch (err) {
                console.error('인증 체크 오류:', err);
                alert('서버 오류로 인증 상태를 확인할 수 없습니다.');
            }
        }

        // 로그인 확인 함수
        function requireLogin() {
            if (!isAuthenticated) {
                alert('로그인이 필요합니다.');
                return false;
            }
            return true;
        }
        // 좋아요 버튼 처리
        function handleLike(postId) {
            if (!requireLogin()) return;

            fetch(`/like/${postId}`, {
                method: 'POST',
                headers: getCsrfHeaders(),
            })
                .then(response => {
                    if (!response.ok) throw new Error('서버 오류');
                    return response.json();
                })
                .then(data => {
                    updateLikeButton(data);
                })
                .catch(error => {
                    console.error('좋아요 처리 오류:', error);
                    alert('좋아요 처리 중 오류가 발생했습니다.');
                });
        }

        // 좋아요 버튼 상태 업데이트
        function updateLikeButton(data) {
            const likeButton = document.getElementById('likeButton');
            const likeCount = document.getElementById('likeCount');

            const isLiked = data.likeId === 1;
            likeButton.textContent = isLiked ? '좋아요 취소' : '좋아요';
            likeCount.textContent = data.likeCount || 0;
        }



        // 입력 창 생성 함수 (대댓글, 댓글 수정 등 공통)
        function createInputBox(type, parentId, placeholder, submitHandler, defaultValue = '') {
            // 기존 입력 창 제거 (중복 방지)
            const existingBox = document.querySelector(`.${type}-box[data-parent-id="${parentId}"]`);
            if (existingBox) existingBox.remove(); // 중복 제거 후 새 창 생성

            // 입력 창 생성
            const box = document.createElement('div');
            box.classList.add(`${type}-box`);
            box.setAttribute('data-parent-id', parentId); // 고유 ID 설정

            box.innerHTML = `
        <textarea id="${type}Content-${parentId}" placeholder="${placeholder}">${defaultValue}</textarea>
        <button class="btn-success submit-btn">작성 완료</button>
        <button class="btn cancel-btn">취소</button>
    `;

            // 입력 창 추가
            document.querySelector(`[data-id="${parentId}"]`).appendChild(box);

            // 이벤트 리스너 추가
            box.querySelector('.submit-btn').addEventListener('click', () => submitHandler(parentId));
            box.querySelector('.cancel-btn').addEventListener('click', () => box.remove());
        }





        // 댓글 추가
        function addComment() {
            if (!requireLogin()) return; // 로그인 체크

            const content = document.getElementById('commentContent').value.trim();
            if (!content) return alert('댓글을 입력해주세요.');


            const requestBody = JSON.stringify({
                postId: Number(postId),
                content: content,
                parentId: null // 기본값 설정
            });

            console.log("요청 본문:", requestBody); // 디버깅용 요청 본문 출력
            fetch(`/comments/${postId}/add`, {
                method: 'POST',
                headers: getCsrfHeaders(),
                body: requestBody
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류 발생');
                    }
                    return response.json(); // JSON 응답만 처리
                })
                .then(data => {
                    console.log('서버 응답:', data);
                    if (data.success) {
                        alert('댓글이 추가되었습니다.');
                        location.reload();
                    } else {
                        alert('댓글 작성 실패: ' + (data.error || '알 수 없는 오류'));
                    }
                })
                .catch(err => {
                    console.error('댓글 추가 오류:', err);
                    alert('댓글 추가 중 오류가 발생했습니다.');
                });
        }


        //대댓글 계층 구조 표현
        // 대댓글 렌더링 함수
        function renderReplies(replies, parentElement) {
            replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.classList.add('reply-item');
                replyElement.style.marginLeft = '30px'; // 들여쓰기

                replyElement.innerHTML = `
                    <p>${reply.content}</p>
                    <button class="edit-reply-btn" data-id="${reply.commentId}">수정</button>
                    <button class="delete-reply-btn" data-id="${reply.commentId}">삭제</button>
                `;
                parentElement.appendChild(replyElement);
            });
        }



        // 댓글 수정
        function editComment(commentId) {
            if (!requireLogin()) return;

            const contentElement = document.querySelector(`[data-id="${commentId}"] p`).textContent;

            createInputBox(
                'edit',
                commentId,
                '수정할 내용을 입력하세요',
                () => submitEdit(commentId),
                contentElement // 기존 내용을 기본값으로 설정
            );
        }

        // 수정 요청 처리
        function submitEdit(commentId) {
            if (!requireLogin()) return;

            const content = document.getElementById(`editContent-${commentId}`).value.trim();
            if (!content) return alert('내용을 입력해주세요.');

            fetch(`/comments/${commentId}/update`, {
                method: 'PUT',
                headers: getCsrfHeaders(),
                body: JSON.stringify({ content: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('댓글이 수정되었습니다.');
                        location.reload();
                    } else {
                        alert('수정 실패.');
                    }
                })
                .catch(err => console.error('수정 오류:', err));
        }





        // 댓글 삭제
        function deleteComment(commentId) {
            if (!requireLogin()) return;

            if (!confirm('댓글을 삭제하시겠습니까?')) return;
            handleRequest(`/comments/${commentId}`, 'DELETE', {}, '댓글이 삭제되었습니다.', '삭제 실패.');
        }





        // 대댓글 작성
        function addReply(parentId) {
            if (!requireLogin()) return;

            createInputBox(
                'reply',
                parentId,
                '대댓글을 입력하세요',
                submitReply
            );
        }

        // 대댓글 제출
        function submitReply(parentId) {
            const replyContent = document.getElementById(`replyContent-${parentId}`).value.trim();
            if (!replyContent) return alert('내용을 입력해주세요.');

            fetch(`/comments/${parentId}/replyAdd`, {
                method: 'POST',
                headers: getCsrfHeaders(),
                body: JSON.stringify({ content: replyContent })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('대댓글이 추가되었습니다.');
                        location.reload();
                    } else {
                        alert('대댓글 작성 실패.');
                    }
                })
                .catch(err => console.error('대댓글 작성 오류:', err));
        }




        function handleRequest(url, method, body, successMessage, errorMessage) {
            fetch(url, {
                method: method,
                headers: getCsrfHeaders(),
                body: JSON.stringify(body)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(successMessage);
                        location.reload();
                    } else {
                        alert(errorMessage);
                    }
                })
                .catch(err => console.error(errorMessage, err));
        }






        async function fetchWithRetry(url, method, body, retries = 3) {
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getCsrfHeaders(), // 최신 CSRF 토큰 사용
                    body: JSON.stringify(body)
                });
                if (!response.ok) throw new Error('서버 오류 발생');
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    console.warn('재시도 중:', retries);
                    return fetchWithRetry(url, method, body, retries - 1);
                } else {
                    alert('오류가 발생했습니다. 다시 시도해주세요.');
                    throw err;
                }
            }
        }


    </script>
</head>

<body>
    <div th:fragment="headerFragment" xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
        <div class="header">
            <div class="header-logo">
                <img alt="시네링크 로고" th:src="@{/img/cine_link_logo.svg}" />
            </div>
            <div class="header-util">
                <div class="route-nav">
                    <ul class="route-list">
                        <li class="route-item"><a href="#">랭킹</a></li>
                        <li class="route-item"><a href="#">통계</a></li>
                        <li class="route-item"><a href="#">커뮤니티</a></li>
                        <li class="route-item"><a href="#">작품</a></li>
                        <li class="route-item">
                            <img alt="검색 아이콘" th:src="@{/img/search.svg}" />
                        </li>
                        <li class="route-item">
                            <img alt="벨 아이콘" th:src="@{/img/bell.svg}" />
                        </li>
                    </ul>
                </div>
                <!-- header.html의 .log-btn 부분 -->
                <div class="log-btn">
                    <!-- 인증된 사용자에게만 '로그아웃' -->
                    <p sec:authorize="isAuthenticated()">로그아웃</p>
                    <!-- 익명 사용자에게만 '로그인' -->
                    <p sec:authorize="isAnonymous()">로그인</p>
                </div>

            </div>
        </div>
    </div>




    <div class="post_detail_main">
        <section class="post_main">
            <div class="post_header">
                <div class="post_mem_info">
                    <div class="post_mem_profile">
                        <!-- 사용자 프로필 -->
                        <p>여기에사용자프로필 사진 들어가야함@@@@@</p>
                    </div>
                    <div class="post_mem_nickname">
                        <!-- 사용자 닉네임 -->
                        <p>사용자 닉네임!!!!!!!!!!</p>
                    </div>
                </div>
                <div class="post_time">
                    <p>
                        작성일:
                        <span th:if="${postOne.postUpdatedAt == null}"
                            th:text="${#dates.format(postOne.postCreatedAt, 'yyyy-MM-dd')}">작성일</span>
                        <span th:if="${postOne.postUpdatedAt != null}"
                            th:text="${#dates.format(postOne.postUpdatedAt, 'yyyy-MM-dd')}">수정일</span>
                    </p>
                </div>
            </div>

            <div class="post_body">
                <div class="post_title">
                    <p th:text="${postOne.postTitle}">드라마 시사회</p>
                </div>

                <div class="post_info_box">
                    <div class="post_info">
                        <p th:text="${postOne.content}">드라마 시사회에서 배우님들이 싸인해주시나요??...</p>
                    </div>

                    <div class="post_tag_box">
                        <div id="tag-container">
                            <!-- 태그가 없는 경우 -->
                            <div th:if="${#lists.isEmpty(tags)}">
                                <p>태그가 없습니다.</p>
                            </div>
                            <!-- 태그가 있는 경우 -->
                            <div th:unless="${#lists.isEmpty(tags)}">
                                <div th:each="tag : ${tags}">
                                    <span class="tag" th:text="'#' + ${tag.tagName}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="view_info">
                <div class="view_cnt">
                    <!--                <img th:src="@{/img/Vector.svg}" alt="조회수">-->
                    <p th:text="${postOne.postViews}">232</p>
                </div>
                <div class="like_cnt">
                    <!--                <img th:src="@{/img/twemoji_growing-heart.svg}" alt="좋아요">-->
                    <button id="likeButton" class="like-btn" th:title="${memId == 0 ? '로그인이 필요합니다.' : ''}"
                        th:data-post-id="${postOne.postId}" th:text="${isLiked ? '좋아요 취소' : '좋아요'}"
                        th:classappend="${isLiked ? 'liked' : 'unliked'}">
                        좋아요
                    </button>

                    <p id="likeCount" th:text="${postOne.postLikeCnt}">11</p> <!-- 좋아요 수 동적으로 출력 -->
                </div>
            </div>

            <div class="cut_line"></div>

            <h2>댓글 목록</h2>

            <div id="commentList">
                <!-- 댓글 입력 폼 -->
                <div class="comment-input-box">
                    <textarea id="commentContent" placeholder="댓글을 입력하세요"></textarea>
                    <button id="submitCommentBtn">댓글 작성</button>


                </div>

                <!-- 댓글 목록 -->
                <div id="comments-list">
                    <div th:each="comment : ${comments}" class="comment-item" th:data-id="${comment.commentId}">
                        <p th:text="${comment.content}"></p>
                        <div class="comment_time">
                            <p>
                                작성시간:
                                <span th:if="${comment.commentUpdatedAt == null}"
                                    th:text="${#dates.format(comment.commentRegAt, 'yyyy-MM-dd')}">작성시간</span>
                                <span th:if="${comment.commentUpdatedAt != null}"
                                    th:text="${#dates.format(comment.commentUpdatedAt, 'yyyy-MM-dd')}">수정시간</span>
                            </p>
                        </div>
                        <div class="comment-actions">
                            <button class="edit-btn" th:data-id="${comment.commentId}">수정</button>
                            <button class="delete-btn" th:data-id="${comment.commentId}">삭제</button>
                            <button class="reply-btn" th:data-id="${comment.commentId}">답글</button>
                        </div>

                        <!-- 대댓글 목록 -->
                        <div class="replies" th:each="reply : ${comment.replies}" th:data-id="${reply.commentId}">
                            <div class="reply-item" th:data-id="${reply.commentId}">
                                <p th:text="${reply.content}"></p>
                                <button class="edit-reply-btn" th:data-id="${reply.commentId}">수정</button>
                                <button class="delete-reply-btn" th:data-id="${reply.commentId}">삭제</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>



</body>

</html>