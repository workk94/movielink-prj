<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>통합 검색</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .tab {
        cursor: pointer;
      }
      .tab.active {
        border-bottom: 3px solid white;
      }
      .search-wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid white;
        color: black;
      }
      .results-section {
        margin-top: 20px;
      }
      .results-section ul {
        list-style: none;
        padding: 0;
      }
      .results-section ul li {
        margin-bottom: 10px;
      }
      .container {
        border: 2px solid white;
      }
      #no-results {
        display: none;
        text-align: center;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="root">
      <div th:replace="~{fragments/header :: headerFragment}"></div>
      <div class="container">
        <div class="search-wrap">
          <input type="text" id="search-input" placeholder="검색어를 입력하세요" />
          <button id="search-button">검색</button>
        </div>
        <div class="results-section">
          <!-- 영화 섹션 -->
          <div id="movie-results">
            <h4>영화</h4><span id="movie-count"></span></span>
            <ul></ul>
            <button id="movie-load-more" style="display: none">더보기</button>
          </div>

          <!-- 인물 섹션 -->
          <div id="people-results">
            <h4>인물</h4><span id="people-count"></span></span>
            <ul></ul>
            <button id="people-load-more" style="display: none">더보기</button>
          </div>

          <!-- 게시글 섹션 -->
          <div id="post-results">
            <h4>게시글</h4><span id="post-count"></span></span>
            <ul></ul>
            <button id="post-load-more" style="display: none">더보기</button>
          </div>

          <div id="no-results">검색 결과가 없습니다.</div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const offsets = { movies: 0, people: 0, posts: 0 };
        const limit = 4;

        $('#search-button').on('click', function () {
          const keyword = $('#search-input').val().trim();
          if (!keyword) return alert('검색어를 입력하세요.');

          resetResults();
          fetchResults(keyword);
        });

        $('#movie-load-more').on('click', () => loadMore('movies'));
        $('#people-load-more').on('click', () => loadMore('people'));
        $('#post-load-more').on('click', () => loadMore('posts'));

        function resetResults() {
          offsets.movies = 0;
          offsets.people = 0;
          offsets.posts = 0;
          $('#movie-results ul, #people-results ul, #post-results ul').empty();
          $('#movie-load-more, #people-load-more, #post-load-more').hide();
          $('#movie-results, #people-results, #post-results').show();
        }

        function fetchResults(keyword) {
          $.ajax({
            type: 'GET',
            url: '/search/results',
            data: { keyword, limit },
            success: (response) => handleResponse(response, 'all'),
            error: () => alert('검색 요청 중 오류가 발생했습니다.')
          });
        }

        function loadMore(type) {
          const keyword = $('#search-input').val().trim();
          if (!keyword) return;

          $.ajax({
            type: 'GET',
            url: '/search/results',
            data: { keyword, [`${type}-offset`]: offsets[type], limit },
            success: (response) => handleResponse(response, type),
            error: () => alert(`${type} 데이터를 불러오는 중 오류가 발생했습니다.`)
          });
        }

        function handleResponse(response, type) {
          const movieResults = response.movies?.results || [];
          const peopleResults = response.people?.results || [];
          const postResults = response.posts?.results || [];

          $('#movie-count').text(response.movies?.totalCount || 0);
          $('#people-count').text(response.people?.totalCount || 0);
          $('#post-count').text(response.posts?.totalCount || 0);

          if (type === 'all' && !movieResults.length && !peopleResults.length && !postResults.length) {
            $('#no-results').show();
            $('#movie-results, #people-results, #post-results').hide();
            return;
          }

          $('#no-results').hide();

          if (type === 'movies' || type === 'all') {
            offsets.movies += movieResults.length;
            renderResults('#movie-results ul', movieResults, 'movie');
            toggleLoadMore('#movie-load-more', offsets.movies, response.movies?.totalCount);
          }

          if (type === 'people' || type === 'all') {
            offsets.people += peopleResults.length;
            renderResults('#people-results ul', peopleResults, 'people');
            toggleLoadMore('#people-load-more', offsets.people, response.people?.totalCount);
          }

          if (type === 'posts' || type === 'all') {
            offsets.posts += postResults.length;
            renderResults('#post-results ul', postResults, 'post');
            toggleLoadMore('#post-load-more', offsets.posts, response.posts?.totalCount);
          }
        }

        function renderResults(container, results, type) {
          results.forEach((item) => {
            const html = {
              movie: `<li>
                  <img src="${item.moviePoster || '/img/placeholder-poster.svg'}" style="width: 100px; height: 150px; object-fit: cover;" />
                  <div>
                    <strong>${item.movieNm}</strong> (${item.movieRlsYear})<br>
                    장르: ${item.movieGenre}<br>
                    평점: ${item.movieScoreAvg}
                  </div>
                </li>`,
              people: `<li>
                  <img src="${item.peopleProfileUrl || '/img/placeholder-people.svg'}" alt="${item.peopleNm}" style="width: 100px; height: 100px; object-fit: cover;" />
                  <div>
                    <strong>${item.peopleNm}</strong>
                  </div>
                </li>`,
              post: `<li>
                  <div>
                    <strong>${item.postTitle}</strong><br>
                    조회수: ${item.postViews}, 추천수: ${item.postLikeCnt}, 댓글수: ${item.commentCnt}
                  </div>
                </li>`
            }[type];

            $(container).append(html);
          });
        }

        function toggleLoadMore(button, offset, total) {
          $(button).toggle(offset < total);
        }
      });
    </script>
  </body>
</html>
